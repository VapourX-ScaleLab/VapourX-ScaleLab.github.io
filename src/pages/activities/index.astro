---
import { getCollection, type CollectionEntry } from 'astro:content'
import { Image } from 'astro:assets'
import { Button } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import PostPreview from '@/components/custom/PostPreview.astro'
import { getUniqueActivityTypes, getActivityTypeDisplayName, getActivitiesByType, getActivityGradient } from '@/utils/activities'

export const prerender = true

// Get all activities (excluding drafts)
const allActivities = await getCollection('activities') as CollectionEntry<'activities'>[]
const nonDraftActivities = allActivities.filter(activity => !activity.data.draft)
const sortedActivities = (nonDraftActivities as CollectionEntry<'activities'>[])
  .sort((a, b) => {
    // order å‡åºï¼›åŒ order æ—¶æŒ‰ publishDate é™åº
    const orderDiff = (a.data.order ?? 999) - (b.data.order ?? 999)
    if (orderDiff !== 0) return orderDiff
    const aDate = new Date(a.data.publishDate).getTime()
    const bDate = new Date(b.data.publishDate).getTime()
    return bDate - aDate
  })
const uniqueActivityTypes = getUniqueActivityTypes(sortedActivities)

const meta = {
  description: 'Our team activities, events, and achievements',
  title: 'Activities'
}

// url builder for activities
const getActivityUrl = (post: CollectionEntry<'activities'>) => `/activities/${post.id}`
---

<PageLayout {meta}>
  <Button title='Back' href='/' style='back' />
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 mt-6 text-3xl font-medium sm:mt-10'>Activities</h1>
      <p class='text-muted-foreground mb-8'>
        è¿‘æœŸæ´»åŠ¨å…¬å‘Šï¼Œæ¬¢è¿æ§åœºï¼
      </p>
    </div>
    
    {
      sortedActivities.length === 0 ? (
        <p>No activities yet.</p>
      ) : (
        <div class='flex flex-col gap-y-6'>
          {/* ä¸‰ä¸ªåˆ†ç±»æ¨ªå‘è½®æ’­ */}
          {uniqueActivityTypes.slice(0, 3).map((activityType) => {
            const items = getActivitiesByType(sortedActivities, activityType)
            return (
              <section class='animate' aria-label={getActivityTypeDisplayName(activityType)}>
                <div class='rounded-2xl p-4 relative glass-effect'>
                  <div class='mb-3 flex items-center justify-between sm:mb-4'>
                    <h2 class='text-lg font-semibold flex items-center gap-2'>
                      <span class='activity-icon'>{activityType === 'å­¦æœ¯æ´»åŠ¨' ? 'ğŸ“' : activityType === 'ç¤¾åŒºæ´»åŠ¨' ? 'ğŸ¤' : activityType === 'è¯»ä¹¦ä¼š' ? 'ğŸ“–' : 'ğŸ“Œ'}</span>
                      <span>{getActivityTypeDisplayName(activityType)}</span>
                    </h2>
                    <Button 
                      title='æŸ¥çœ‹å…¨éƒ¨' 
                      href={`/activities/type/${activityType}`} 
                      style='default' 
                    />
                  </div>
                  <div class='marquee-viewport relative mx-auto' style='--gap: 1rem;'>
                    <ul class={'marquee-track flex'} data-animate='true' data-duplicated='true'>
                      {items.map((activity) => (
                        <li class='activity-card relative rounded-xl border overflow-hidden' style='width: var(--card-w); height: var(--card-h); margin-right: var(--gap)'>
                          <a class='block w-full h-full' href={getActivityUrl(activity)} data-astro-prefetch>
                            {
                              activity.data.heroImage ? (
                                <Image {...activity.data.heroImage} alt={activity.data.title} class='absolute inset-0 h-full w-full object-cover' loading='eager' />
                              ) : (
                                <div 
                                  class='absolute inset-0 h-full w-full'
                                  style={`background-image: ${getActivityGradient(activity.id)}; background-size: cover; background-position: center;`}
                                ></div>
                              )
                            }
                            <div class='absolute inset-0 color-scheme-mask'></div>
                            <div class='absolute inset-0 bottom-gradient'></div>
                            <div class='absolute inset-x-0 bottom-0 text-overlay' aria-hidden='true'></div>
                            <div class='absolute inset-x-0 bottom-0 p-3 text-white'>
                              <div class='flex items-center justify-between gap-2'>
                                <h3 class='text-sm font-semibold line-clamp-1'>{activity.data.title}</h3>
                                <span class='text-[10px] opacity-90 whitespace-nowrap'>
                                  {new Date((activity.data.updatedDate ?? activity.data.publishDate) as any).toLocaleDateString()}
                                </span>
                              </div>
                              {activity.data.description && (
                                <p class='mt-1 text-xs opacity-95 line-clamp-2'>
                                  {activity.data.description}
                                </p>
                              )}
                              <div class='mt-1.5 flex items-center gap-2 text-[11px] opacity-95'>
                                {activity.data.author && <span class='line-clamp-1'>{activity.data.author}</span>}
                                {activity.data.duration && <span class='opacity-90'>Â· {activity.data.duration}</span>}
                              </div>
                            </div>
                          </a>
                        </li>
                      ))}
                      {/* å¤åˆ¶å¡ç‰‡ç”¨äºæ— é™å¾ªç¯ - åªåœ¨æœ‰å¤šä¸ªæ´»åŠ¨æ—¶æ‰å¤åˆ¶ */}
                      {items.length > 1 && items.map((activity) => (
                        <li class='activity-card relative rounded-xl border overflow-hidden' style='width: var(--card-w); height: var(--card-h); margin-right: var(--gap)' aria-hidden='true'>
                          <a class='block w-full h-full' href={getActivityUrl(activity)} data-astro-prefetch tabindex='-1'>
                            {
                              activity.data.heroImage ? (
                                <Image {...activity.data.heroImage} alt={activity.data.title} class='absolute inset-0 h-full w-full object-cover' loading='eager' />
                              ) : (
                                <div 
                                  class='absolute inset-0 h-full w-full'
                                  style={`background-image: ${getActivityGradient(activity.id)}; background-size: cover; background-position: center;`}
                                ></div>
                              )
                            }
                            <div class='absolute inset-0 color-scheme-mask'></div>
                            <div class='absolute inset-0 bottom-gradient'></div>
                            <div class='absolute inset-x-0 bottom-0 text-overlay' aria-hidden='true'></div>
                            <div class='absolute inset-x-0 bottom-0 p-3 text-white'>
                              <div class='flex items-center justify-between gap-2'>
                                <h3 class='text-sm font-semibold line-clamp-1'>{activity.data.title}</h3>
                                <span class='text-[10px] opacity-90 whitespace-nowrap'>
                                  {new Date((activity.data.updatedDate ?? activity.data.publishDate) as any).toLocaleDateString()}
                                </span>
                              </div>
                              {activity.data.description && (
                                <p class='mt-1 text-xs opacity-95 line-clamp-2'>
                                  {activity.data.description}
                                </p>
                              )}
                              <div class='mt-1.5 flex items-center gap-2 text-[11px] opacity-95'>
                                {activity.data.author && <span class='line-clamp-1'>{activity.data.author}</span>}
                                {activity.data.duration && <span class='opacity-90'>Â· {activity.data.duration}</span>}
                              </div>
                            </div>
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </section>
            )
          })}
        </div>
      )
    }
  </main>
</PageLayout> 

<style>
  /* æ´»åŠ¨ç±»å‹å›¾æ ‡åŠ¨ç”» */
  .activity-icon {
    display: inline-block;
    font-size: 1.2em;
    animation: iconFloat 3s ease-in-out infinite;
  }
  
  @keyframes iconFloat {
    0%, 100% {
      transform: translateY(0) scale(1);
    }
    50% {
      transform: translateY(-3px) scale(1.05);
    }
  }
  
  /* é¼ æ ‡æ‚¬åœæ—¶å›¾æ ‡æ—‹è½¬ */
  .glass-effect:hover .activity-icon {
    animation: iconRotate 0.6s ease-in-out;
  }
  
  @keyframes iconRotate {
    0%, 100% {
      transform: rotate(0deg) scale(1);
    }
    50% {
      transform: rotate(10deg) scale(1.1);
    }
  }

  /* æ¯›ç»ç’ƒæ•ˆæœ */
  .glass-effect {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }
  
  /* æš—è‰²æ¨¡å¼ä¸‹çš„æ¯›ç»ç’ƒæ•ˆæœ */
  :global(.dark) .glass-effect {
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
  }

  .marquee-viewport {
    width: 100%;
    height: calc(var(--card-h) + 0.25rem);
    overflow: hidden;
    /* æ¸å˜å®½åº¦å˜é‡ï¼Œå¯æŒ‰éœ€è°ƒèŠ‚ */
    --edge-fade: 72px;
    position: relative;
  }
  
  /* å®½åº¦è¶…å‡ºæ—¶ï¼šç›´æ¥æ˜¾ç¤ºå·¦å³ä¸¤ä¾§æ¸å˜ */
  .marquee-viewport.has-overflow {
    -webkit-mask-image: linear-gradient(to right, rgba(0,0,0,0), #000 var(--edge-fade), #000 calc(100% - var(--edge-fade)), rgba(0,0,0,0));
    mask-image: linear-gradient(to right, rgba(0,0,0,0), #000 var(--edge-fade), #000 calc(100% - var(--edge-fade)), rgba(0,0,0,0));
  }
  
  .marquee-track {
    will-change: transform;
    display: flex;
    flex-wrap: nowrap;
  }
  
  .marquee-track > .activity-card:last-child {
    margin-right: 0;
  }
  
  /* æ— é™å¾ªç¯åŠ¨ç”»ä¸éœ€è¦ animation-iteration-countï¼Œç”¨ JavaScript æ§åˆ¶ */
  .marquee-track[data-animate='true'] {
    /* animation ç”± JavaScript åŠ¨æ€è®¾ç½® */
  }
  
  /* å¡ç‰‡æ‚¬åœæ—¶åªæ”¾å¤§èƒŒæ™¯å›¾ */
  .activity-card {
    z-index: 1;
    position: relative;
  }
  
  .activity-card:hover {
    z-index: 10;
  }
  
  /* èƒŒæ™¯å›¾ç‰‡çš„ç¼©æ”¾æ•ˆæœ */
  .activity-card img,
  .activity-card > a > div:first-child {
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .activity-card:hover img,
  .activity-card:hover > a > div:first-child {
    transform: scale(1.15);
  }

  /* 3:2 ç»Ÿä¸€å¡ç‰‡å°ºå¯¸ï¼ˆé«˜åº¦ä¸ºå®½åº¦çš„2/3ï¼‰ */
  .marquee-viewport { 
    --card-w: 280px; 
    --card-h: 187px; /* 280 * 2/3 â‰ˆ 187 */
  }
  @media (min-width: 640px) {
    .marquee-viewport { 
      --card-w: 320px; 
      --card-h: 213px; /* 320 * 2/3 â‰ˆ 213 */
    }
  }
  @media (min-width: 1024px) {
    .marquee-viewport { 
      --card-w: 360px; 
      --card-h: 240px; /* 360 * 2/3 = 240 */
    }
  }

  /* å¼ºåˆ¶æ‰€æœ‰å¡ç‰‡ä½¿ç”¨ç»Ÿä¸€å°ºå¯¸ */
  .activity-card {
    width: var(--card-w) !important;
    height: var(--card-h) !important;
    flex-shrink: 0;
    aspect-ratio: 3 / 2;
  }
  
  .activity-card img,
  .activity-card > a {
    aspect-ratio: 3 / 2;
  }

  /* å›¾ç‰‡é€æ˜åº¦æ¸å˜é®ç½©ï¼ˆæ— è‰²åï¼Œé¿å…çº¯é»‘/ç™½è¦†ç›–ï¼‰ */
  .color-scheme-mask {
    background: linear-gradient(to bottom, rgba(0,0,0,0.18), rgba(0,0,0,0.10) 35%, rgba(0,0,0,0) 65%);
  }
  .bottom-gradient { background: linear-gradient(to top, rgba(0,0,0,0.55), rgba(0,0,0,0.25), rgba(0,0,0,0)); }
  .text-overlay {
    height: 46%;
    pointer-events: none;
    background: linear-gradient(
      to top,
      rgba(0,0,0,0.72) 0%,
      rgba(0,0,0,0.50) 60%,
      rgba(0,0,0,0.20) 85%,
      rgba(0,0,0,0) 100%
    );
  }
</style>

<script>
  // @ts-nocheck
  const pxPerSec = 50 // æ»šåŠ¨é€Ÿåº¦ï¼šæ¯ç§’ç§»åŠ¨çš„åƒç´ æ•°
  const animationDelay = 800 // åˆå§‹å»¶è¿Ÿï¼š0.8ç§’åå¼€å§‹æ»šåŠ¨

  /** @type {(viewport: HTMLElement) => void} */
  const setupMarquee = (viewport) => {
    const track = viewport.querySelector('.marquee-track')
    if (!(track instanceof HTMLElement)) return

    const animate = track.getAttribute('data-animate') === 'true'
    if (!animate) {
      viewport.classList.remove('has-overflow')
      track.style.animation = 'none'
      return
    }

    const cards = Array.from(track.querySelectorAll('.activity-card'))
    const originalCards = cards.filter((el) => el instanceof HTMLElement && el.getAttribute('aria-hidden') !== 'true')
    const originalCount = originalCards.length
    if (originalCount === 0) {
      track.style.animation = 'none'
      viewport.classList.remove('has-overflow')
      return
    }

    // è®¡ç®—é¦–ç»„å¡ç‰‡çœŸå®å®½åº¦ï¼ˆåŒ…å« margin-rightï¼‰
    let singleGroupWidth = 0
    for (let i = 0; i < originalCount; i++) {
      const el = cards[i] || originalCards[i]
      if (!(el instanceof HTMLElement)) continue
      const rect = el.getBoundingClientRect()
      const style = getComputedStyle(el)
      const marginRight = parseFloat(style.marginRight) || 0
      singleGroupWidth += rect.width + marginRight
    }

    const viewportWidth = viewport.clientWidth

    if (singleGroupWidth > viewportWidth) {
      viewport.classList.add('has-overflow')

      const duration = singleGroupWidth / pxPerSec
      track.style.setProperty('--translate-distance', `-${singleGroupWidth}px`)
      track.style.animation = `marquee-slide ${duration}s linear ${animationDelay / 1000}s infinite`

      // ç«‹å³è®¾ç½®åŠ¨ç”»æ§åˆ¶ï¼Œæ— éœ€ç­‰å¾…
      let currentPlaybackRate = 1.0
      let targetPlaybackRate = 1.0
      let rafId = null
      let animationObj = null

      // å¹³æ»‘è¿‡æ¸¡å‡½æ•° - æ”¹è¿›ç‰ˆï¼Œå…è®¸ä¸­æ–­å’Œæ›´æ–°ç›®æ ‡
      const smoothTransition = (targetRate) => {
        targetPlaybackRate = targetRate

        // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»å¸§
        if (rafId) {
          cancelAnimationFrame(rafId)
        }

        // å¦‚æœåŠ¨ç”»å¯¹è±¡è¿˜æœªè·å–ï¼Œå°è¯•è·å–
        if (!animationObj) {
          const animations = track.getAnimations()
          if (animations.length > 0) {
            animationObj = animations[0]
          } else {
            // åŠ¨ç”»è¿˜æœªå¼€å§‹ï¼Œç¨åé‡è¯•
            setTimeout(() => smoothTransition(targetRate), 50)
            return
          }
        }

        const startRate = currentPlaybackRate
        const startTime = performance.now()
        const transitionDuration = 600 // 0.6ç§’è¿‡æ¸¡æ—¶é—´ï¼ˆæ›´å¿«å“åº”ï¼‰

        const animateRate = (currentTime) => {
          const elapsed = currentTime - startTime
          const progress = Math.min(elapsed / transitionDuration, 1)
          
          // ä½¿ç”¨ ease-out ç¼“åŠ¨å‡½æ•°ï¼Œæ›´å¿«å“åº”
          const easeProgress = 1 - Math.pow(1 - progress, 3)

          currentPlaybackRate = startRate + (targetPlaybackRate - startRate) * easeProgress
          if (animationObj) {
            animationObj.playbackRate = currentPlaybackRate
          }

          if (progress < 1 && currentPlaybackRate !== targetPlaybackRate) {
            rafId = requestAnimationFrame(animateRate)
          } else {
            rafId = null
          }
        }

        rafId = requestAnimationFrame(animateRate)
      }

      // ç«‹å³æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      viewport.addEventListener('mouseenter', () => {
        smoothTransition(0.5)
      })

      viewport.addEventListener('mouseleave', () => {
        smoothTransition(1.0)
      })
    } else {
      viewport.classList.remove('has-overflow')
      track.style.animation = 'none'
    }
  }

  function initMarquees() {
    document.querySelectorAll('.marquee-viewport').forEach((el) => {
      if (el instanceof HTMLElement) setupMarquee(el)
    })
  }

  /** @type {number} */
  let resizeRaf = 0
  window.addEventListener('resize', () => {
    cancelAnimationFrame(resizeRaf)
    resizeRaf = requestAnimationFrame(() => initMarquees())
  })

  requestAnimationFrame(() => initMarquees())

  // æ·»åŠ åŠ¨ç”»å…³é”®å¸§æ ·å¼
  const style = document.createElement('style')
  style.textContent = `
    @keyframes marquee-slide {
      0% { transform: translateX(0); }
      100% { transform: translateX(var(--translate-distance, -100%)); }
    }
  `
  document.head.appendChild(style)
</script>
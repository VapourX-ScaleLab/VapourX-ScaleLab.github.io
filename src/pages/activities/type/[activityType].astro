---
import { getCollection, type CollectionEntry } from 'astro:content'
import { sortMDByDate } from 'astro-pure/server'
import { Button } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import PostPreview from '@/components/custom/PostPreview.astro'
import Icon from '@/components/custom/Icon.astro'
import { getUniqueActivityTypes, getActivityTypeDisplayName, getActivitiesByType } from '@/utils/activities'

export const prerender = true

export async function getStaticPaths() {
  const allActivities = await getCollection('activities')
  const uniqueActivityTypes = getUniqueActivityTypes(allActivities)
  
  return uniqueActivityTypes.map((activityType) => ({
    params: { activityType },
    props: { activityType }
  }))
}

const { activityType } = Astro.props

// Get all activities
const allActivities = await getCollection('activities') as CollectionEntry<'activities'>[]
const sortedActivities = sortMDByDate(allActivities) as CollectionEntry<'activities'>[]
const filteredActivities = getActivitiesByType(sortedActivities, activityType)
const uniqueActivityTypes = getUniqueActivityTypes(sortedActivities)

const meta = {
  description: `Activities of type: ${getActivityTypeDisplayName(activityType)}`,
  title: `${getActivityTypeDisplayName(activityType)} - Activities`
}
---

<PageLayout {meta}>
  <Button title='Back' href='/activities' style='back' />
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 mt-6 text-3xl font-medium sm:mt-10'>
        {getActivityTypeDisplayName(activityType)} 活动
      </h1>
      <p class='text-muted-foreground mb-8'>
        查看所有 {getActivityTypeDisplayName(activityType)} 类型的活动
      </p>
    </div>
    
    {
      filteredActivities.length === 0 ? (
        <p>No activities found for this type.</p>
      ) : (
        <div class='grid gap-y-16 sm:grid-cols-[3fr_1fr] sm:gap-x-8'>
          <section aria-label='Activities list' class='animate' id='content'>
            {/* header */}
            <div class='mb-3 flex flex-col justify-between text-sm sm:mb-5 sm:flex-row'>
              <span class='text-muted-foreground'>
                Showing {filteredActivities.length} of {sortedActivities.length} activities
              </span>
            </div>
            
            {/* activities */}
            <ul class='flex flex-col gap-y-4 text-start'>
              {filteredActivities.map((activity) => (
                <PostPreview post={activity} detailed />
              ))}
            </ul>
          </section>

          {/* sidebar */}
          <aside class='animate' id='sidebar'>
            {/* Activity Types Section */}
            {!!uniqueActivityTypes.length && (
              <div class='mb-8'>
                <h2 class='mb-4 flex items-center text-lg font-semibold'>
                  <Icon name='list' class='me-2' />
                  活动类型
                </h2>
                <ul class='text-bgColor flex flex-wrap gap-2'>
                  {/* 全部类型 */}
                  <li>
                    <Button 
                      title="全部" 
                      href="/activities" 
                      style={activityType === 'all' ? 'default' : 'pill'}
                    />
                  </li>
                  {/* 其他类型 */}
                  {uniqueActivityTypes.map((type) => (
                    <li>
                      <Button 
                        title={getActivityTypeDisplayName(type)} 
                        href={`/activities/type/${type}`} 
                        style={type === activityType ? 'default' : 'pill'}
                      />
                    </li>
                  ))}
                </ul>
              </div>
            )}


          </aside>
        </div>
      )
    }
  </main>
</PageLayout> 